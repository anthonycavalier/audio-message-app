<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ultrasound Message Detector</title>
</head>
<body>
    <h1>Listen for Hidden Messages</h1>
    <button id="start-listening">Start Listening</button>
    <p id="status"></p>
    <p id="decoded-message"></p>

    <script>
        document.getElementById('start-listening').addEventListener('click', listenForSongAndUltrasound);

        async function listenForSongAndUltrasound() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const microphone = audioContext.createMediaStreamSource(stream);
            const analyser = audioContext.createAnalyser();

            microphone.connect(analyser);
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            document.getElementById('status').innerText = "Listening...";

            function detectAudio() {
                analyser.getByteFrequencyData(dataArray);
                const detectedFrequencies = getDetectedFrequencies(dataArray, audioContext.sampleRate);
                const detectedSong = detectSong(dataArray);
                
                if (detectedFrequencies.length > 0) {
                    const decodedMessage = decodeMessage(detectedFrequencies);
                    if (detectedSong) {
                        handleDetectedSignal(decodedMessage);
                    }
                } else {
                    document.getElementById('status').innerText = "No hidden frequencies detected.";
                }
                requestAnimationFrame(detectAudio);
            }

            detectAudio();
        }

        function getDetectedFrequencies(dataArray, sampleRate) {
            const threshold = 50; // Threshold for detection
            const detectedFrequencies = [];
            for (let i = 0; i < dataArray.length; i++) {
                if (dataArray[i] > threshold) {
                    const frequency = Math.round(i * (sampleRate / dataArray.length)); // Calculate frequency
                    if (frequency > 20000) { // Only consider ultrasonic frequencies
                        detectedFrequencies.push(frequency);
                    }
                }
            }
            return detectedFrequencies;
        }

        function detectSong(dataArray) {
            // For simplicity, we can check for specific known frequencies or use a range
            const songFrequencyRange = [20000, 21000]; // Example range for song
            for (let i = 0; i < dataArray.length; i++) {
                const frequency = Math.round(i * (sampleRate / dataArray.length));
                if (frequency >= songFrequencyRange[0] && frequency <= songFrequencyRange[1]) {
                    return true; // Detected song
                }
            }
            return false;
        }

        function decodeMessage(frequencies) {
            const messageChars = frequencies.map(freq => {
                return String.fromCharCode(((freq / 100) - 20) % 256); // Reverse encoding
            });
            return messageChars.join('');
        }

        function handleDetectedSignal(decodedMessage) {
            document.getElementById('status').innerText = "Signal detected! Decoding message...";
            document.getElementById('decoded-message').innerText = `Decoded Message: ${decodedMessage}`;
        }
    </script>
</body>
</html>
